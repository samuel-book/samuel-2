
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Creating synthetic SAMUeL data data with SMOTE &#8212; SAMueL Stroke Audit Machine Learning 2</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Testing of SAMueL-1 synthetic data: descriptive statistics" href="02b_test_synthetic_descriptive.html" />
    <link rel="prev" title="Creating synthetic Titanic passenger data with SMOTE" href="01_synthetic_titanic_data%20_SMOTE.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">SAMueL Stroke Audit Machine Learning 2</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/intro.html">
   Introduction to SAMueL-2 (Stroke Audit Machine Learning)
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Bid documents
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/plain_english_plan.html">
   Research plan (plain English summary)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/plan.html">
   Research plan (detailed)
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  SAMueL-1 extension - embedding neural nets
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../samuel_1/neural_net/outline.html">
   Outline - what is in this section?
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_1/neural_net/001a_1d_modular_fit.html">
     Modular TensorFlow model with 1D embedding - Train and save models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_1/neural_net/001b_1d_modular_analyse.html">
     Modular TensorFlow model with 1D embedding - analyse
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_1/neural_net/002a_2d_modular_fit.html">
     Modular TensorFlow model with 2D embedding - Train and save models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_1/neural_net/002b_2d_modular_analyse.html">
     Modular TensorFlow model with 2D embedding - analyse
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_1/neural_net/003a_generate_1d_nets_for_10k.html">
     Modular TensorFlow model with 1D embedding - Train and save model for 10k patient subset
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_1/neural_net/003b_analyse_10k_1d_modular.html">
     Investigating the output of neural net embedding subnets
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_1/neural_net/04a_predict_contentious_patients.html">
     Train an embedding neural network to discern ‘contentious patients’ from those with high agreement to thrombolyse
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  SAMueL-1 extension - Explaining models with Shapley values
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../samuel_1/shap/outline.html">
   What is in this section?
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_1/shap/01_log_reg_shap.html">
     Explaining logistic regression model predictions with Shapley values
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_1/shap/02_rf_shap.html">
     Explaining random forest model predictions with Shapley values
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Demo of synthetic data method
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="outline.html">
   Outline - what is in this section?
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="01_synthetic_titanic_data%20_SMOTE.html">
     Creating synthetic Titanic passenger data with SMOTE
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Creating synthetic SAMUeL data  data with SMOTE
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="02b_test_synthetic_descriptive.html">
     Testing of SAMueL-1 synthetic data: descriptive statistics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="02c_compare_distances_to_real_data.html">
     Testing of SAMueL-1 synthetic data: Compare differences between synthetic data and real data nearest-neighbours
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="02d_test_synthetic_random_forest.html">
     Testing of SAMueL-1 synthetic data: random forest model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="02e_test_synthetic_logistic_regression.html">
     Testing of SAMueL-1 synthetic data: logistic regression model
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Miscellaneous experiments
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../samuel_1/compare_to_benchmark/01_compare_10k_cohort_models.html">
   A comparison of 10K corhort thrombolysis rates across hospitals using different model types
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../samuel_1/compare_to_benchmark/02_compare_xgb_single_vs_multi_predictions.html">
   A comparison of 10K corhort thrombolysis decisions across single and multiple XG Boost models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../samuel_1/compare_to_benchmark/03_xgb_single_fit.html">
   XG Boost Classifier - Fitting to all stroke teams together
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../samuel_1/compare_to_benchmark/04_xgb_hospital_fit_accuracy.html">
   XG Boost Classifier - Fitting hospital-specific models
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/synthetic_data_demo/02a_synthetic_samuel1_data _SMOTE.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#description-of-smote">
   Description of SMOTE
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#handling-integer-binary-and-categorical-data">
     Handling integer, binary, and categorical data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#implementation-with-imblearn">
     Implementation with IMBLEARN
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-packages">
   Load packages
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-minimum-allowable-distance-from-synthetic-to-closest-real-data">
   Set minimum allowable distance from synthetic to closest real data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-data">
   Load data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#functions">
   Functions
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#function-to-standardise-data">
     Function to standardise data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#function-to-calculate-accuracy-measures">
     Function to calculate accuracy measures
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#function-to-create-raw-synthetic-data">
     Function to create raw synthetic data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#function-to-process-one-hot-categorical-data">
     Function to process one-hot categorical data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#function-to-add-nearest-real-data-neighbour-to-synthetic-data">
     Function to add nearest real data neighbour to synthetic data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-lists-of-categorical-one-hot-coded-and-integer-fields">
   Set lists of categorical (one-hot coded) and integer fields
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-synthetic-data">
   Create synthetic data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-synthetic-data-and-process-categorical-one-hot-and-integer-data">
     Create synthetic data and process categorical (one-hot) and integer data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#add-distance-measure-to-original-data">
     Add distance measure to original data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#remove-points-with-identical-points-or-near-neighbours-in-real-data">
     Remove points with identical points or near neighbours in real data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#save-synthetic-data">
     Save synthetic data
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Creating synthetic SAMUeL data  data with SMOTE</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#description-of-smote">
   Description of SMOTE
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#handling-integer-binary-and-categorical-data">
     Handling integer, binary, and categorical data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#implementation-with-imblearn">
     Implementation with IMBLEARN
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-packages">
   Load packages
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-minimum-allowable-distance-from-synthetic-to-closest-real-data">
   Set minimum allowable distance from synthetic to closest real data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-data">
   Load data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#functions">
   Functions
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#function-to-standardise-data">
     Function to standardise data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#function-to-calculate-accuracy-measures">
     Function to calculate accuracy measures
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#function-to-create-raw-synthetic-data">
     Function to create raw synthetic data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#function-to-process-one-hot-categorical-data">
     Function to process one-hot categorical data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#function-to-add-nearest-real-data-neighbour-to-synthetic-data">
     Function to add nearest real data neighbour to synthetic data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-lists-of-categorical-one-hot-coded-and-integer-fields">
   Set lists of categorical (one-hot coded) and integer fields
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-synthetic-data">
   Create synthetic data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-synthetic-data-and-process-categorical-one-hot-and-integer-data">
     Create synthetic data and process categorical (one-hot) and integer data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#add-distance-measure-to-original-data">
     Add distance measure to original data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#remove-points-with-identical-points-or-near-neighbours-in-real-data">
     Remove points with identical points or near neighbours in real data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#save-synthetic-data">
     Save synthetic data
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="creating-synthetic-samuel-data-data-with-smote">
<h1>Creating synthetic SAMUeL data  data with SMOTE<a class="headerlink" href="#creating-synthetic-samuel-data-data-with-smote" title="Permalink to this headline">¶</a></h1>
<div class="section" id="description-of-smote">
<h2>Description of SMOTE<a class="headerlink" href="#description-of-smote" title="Permalink to this headline">¶</a></h2>
<p>SMOTE stands for Synthetic Minority Oversampling Technique [1]. SMOTE is more commonly used to create additional data to enhance modelling fitting, especially when one or more classes have low prevalence in the data set. Hence the description of <em>oversampling</em>.</p>
<p>SMOTE works by finding near-neighbor points in the original data, and creating new data points from interpolating between two near-neighbor points.</p>
<p>Here we remove the real data used to create the synthetic data, leaving only the synthetic data. After generating synthetic data we remove any data points that, by chance, are identical to original real data points, and also remove 10% of points that are closest to the original data points. We measure ‘closeness’ by the Cartesian distance between standardised data values.</p>
<p><img alt="" src="../_images/smote.png" /></p>
<p><em>Demonstration of SMOTE method. (a) Data points with two features (shown on x and y axes) are represented. Points are colour-coded by class label. (b) A data point from a class is picked at random, shown by the black point, and then the closest neighbours of the same class are identified, as shown by yellow points. Here we show 3 closest neighbours, but the default in the SMOTE <code class="docutils literal notranslate"><span class="pre">Imbalanced-Learn</span></code> library is 6. One of those near-neighbour points is selected at random (shown by the second black point). A new data point, shown in red, is created at a random distance between the two selected data points.</em></p>
<div class="section" id="handling-integer-binary-and-categorical-data">
<h3>Handling integer, binary, and categorical data<a class="headerlink" href="#handling-integer-binary-and-categorical-data" title="Permalink to this headline">¶</a></h3>
<p>The standard SMOTE method generates floating point non-integer) values between data points. There are alternative ways of handing integer, binary, and categorical data using the SMOTE method. Here the methods we use are:</p>
<ul class="simple">
<li><p><em>Integer</em> values: Round the resulting synthetic data point value to the closest integer.</p></li>
<li><p><em>Binary</em>: Code the value as 0 or 1, and round the resulting synthetic data point value to the closest integer (0 or 1).</p></li>
<li><p><em>Categorical</em>: One-hot encode the categorical feature. Generate the synthetic data for each category value. Identify the category with the highest value and set to 1 while setting all others to 0.</p></li>
</ul>
</div>
<div class="section" id="implementation-with-imblearn">
<h3>Implementation with IMBLEARN<a class="headerlink" href="#implementation-with-imblearn" title="Permalink to this headline">¶</a></h3>
<p>Here use the implementation in the IMBLEARN IMBALANCED-LEARN [2]</p>
<p>[1] Chawla, N.V., Bowyer, K.W., Hall, L.O., Kegelmeyer, W.P. “SMOTE: Synthetic minority over-sampling technique,” Journal of Artificial Intelligence Research, vol. 16, pp. 321-357, 2002.</p>
<p>[2] Lemaitre, G., Nogueira, F. and Aridas, C. (2016), Imbalanced-learn: A Python Toolbox to Tackle the Curse of Imbalanced Datasets in Machine Learning. arXiv:1609.06570 (<a class="reference external" href="https://pypi.org/project/imbalanced-learn/">https://pypi.org/project/imbalanced-learn/</a>, <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">imbalanced-learn</span></code>).</p>
</div>
</div>
<div class="section" id="load-packages">
<h2>Load packages<a class="headerlink" href="#load-packages" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Import machine learning methods</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">NearestNeighbors</span>

<span class="c1"># Import package for SMOTE</span>
<span class="kn">from</span> <span class="nn">imblearn.over_sampling</span> <span class="kn">import</span> <span class="n">SMOTE</span>

<span class="c1"># Turn warnings off to keep notebook clean</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="set-minimum-allowable-distance-from-synthetic-to-closest-real-data">
<h2>Set minimum allowable distance from synthetic to closest real data<a class="headerlink" href="#set-minimum-allowable-distance-from-synthetic-to-closest-real-data" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">min_epsilon</span> <span class="o">=</span> <span class="mf">0.5</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="load-data">
<h2>Load data<a class="headerlink" href="#load-data" title="Permalink to this headline">¶</a></h2>
<p>Synthetic data is based on the training data of a train/test split so performance can then be tested against a test set not used to make synthetic data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_loc</span> <span class="o">=</span> <span class="s1">&#39;./../data/sam_1/kfold_5fold/&#39;</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_loc</span> <span class="o">+</span> <span class="s1">&#39;train_0.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="functions">
<h2>Functions<a class="headerlink" href="#functions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="function-to-standardise-data">
<h3>Function to standardise data<a class="headerlink" href="#function-to-standardise-data" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">standardise_data</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts all data to a similar scale.</span>
<span class="sd">    Standardisation subtracts mean and divides by standard deviation</span>
<span class="sd">    for each feature.</span>
<span class="sd">    Standardised data will have a mena of 0 and standard deviation of 1.</span>
<span class="sd">    The training data mean and standard deviation is used to standardise both</span>
<span class="sd">    training and test set data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Initialise a new scaling object for normalising input data</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span> 

    <span class="c1"># Set up the scaler just on the training set</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>

    <span class="c1"># Apply the scaler to the training and test sets</span>
    <span class="n">train_std</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    <span class="n">test_std</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">train_std</span><span class="p">,</span> <span class="n">test_std</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="function-to-calculate-accuracy-measures">
<h3>Function to calculate accuracy measures<a class="headerlink" href="#function-to-calculate-accuracy-measures" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="function-to-create-raw-synthetic-data">
<h3>Function to create raw synthetic data<a class="headerlink" href="#function-to-create-raw-synthetic-data" title="Permalink to this headline">¶</a></h3>
<p>Data generated are floats; this will need processing for integer, binary, and categorical data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_synthetic_data_smote</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">number_of_samples</span><span class="o">=</span><span class="p">[</span><span class="mi">1000</span><span class="p">,</span><span class="mi">1000</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Synthetic data generation for two classes.</span>
<span class="sd">        </span>
<span class="sd">    Inputs</span>
<span class="sd">    ------</span>
<span class="sd">    original_data: X, y numpy arrays (y should have label 0 and 1)</span>
<span class="sd">    number_of_samples: number of samples to generate (list for y=0, y=1)</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    X_synthetic: NumPy array</span>
<span class="sd">    y_synthetic: NumPy array</span>
<span class="sd">    &quot;&quot;&quot;</span>
       
    <span class="c1"># Count instances in each class</span>
    <span class="n">count_label_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">count_label_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># SMOTE requires final class counts; add current counts to required counts</span>
    <span class="n">n_class_0</span> <span class="o">=</span> <span class="n">number_of_samples</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">count_label_0</span>
    <span class="n">n_class_1</span> <span class="o">=</span> <span class="n">number_of_samples</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">count_label_1</span>

    <span class="c1"># Get SMOTE points</span>
    <span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span> <span class="o">=</span> <span class="n">SMOTE</span><span class="p">(</span>
        <span class="n">sampling_strategy</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="n">n_class_0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">n_class_1</span><span class="p">},</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fit_resample</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="c1"># Get just the additional (synethetic) data points</span>
    <span class="n">X_synthetic</span> <span class="o">=</span> <span class="n">X_resampled</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">):]</span>
    <span class="n">y_synthetic</span> <span class="o">=</span> <span class="n">y_resampled</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">):]</span>
                                                                   
    <span class="k">return</span> <span class="n">X_synthetic</span><span class="p">,</span> <span class="n">y_synthetic</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="function-to-process-one-hot-categorical-data">
<h3>Function to process one-hot categorical data<a class="headerlink" href="#function-to-process-one-hot-categorical-data" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_one_hot</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes a list/array/series and returns 1 for highest value and 0 for all </span>
<span class="sd">    others</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get argmax</span>
    <span class="n">highest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="c1"># Set all values to zero</span>
    <span class="n">x</span> <span class="o">*=</span> <span class="mf">0.0</span>
    <span class="c1"># Set argmax to one</span>
    <span class="n">x</span><span class="p">[</span><span class="n">highest</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="function-to-add-nearest-real-data-neighbour-to-synthetic-data">
<h3>Function to add nearest real data neighbour to synthetic data<a class="headerlink" href="#function-to-add-nearest-real-data-neighbour-to-synthetic-data" title="Permalink to this headline">¶</a></h3>
<p>Find nearest neighbour in the real data set (based on Cartesian distance of standardised data).Find nearest neighbour in the real data set (based on Cartesian distance of standardised data).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">find_distance_to_closest_real_data</span><span class="p">(</span><span class="n">X_actual</span><span class="p">,</span> <span class="n">X_synthetic</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find nearest neighbour in the real data set (based on Cartesian distance of</span>
<span class="sd">    standardised data).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Standardise data (based on real training data)</span>
    <span class="n">X_actual_std</span><span class="p">,</span> <span class="n">X_synth_std</span> <span class="o">=</span> <span class="n">standardise_data</span><span class="p">(</span><span class="n">X_actual</span><span class="p">,</span> <span class="n">X_synthetic</span><span class="p">)</span>

    <span class="c1"># Use ScitLearn neighbors.NearestNeighbors to get nearest neighbour    </span>
    <span class="n">nn</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_actual_std</span><span class="p">)</span>
    <span class="n">dists</span><span class="p">,</span> <span class="n">idxs</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="n">X_synth_std</span><span class="p">)</span>

    <span class="c1"># Convert row idxs to index in original index in X_actual</span>
    <span class="n">real_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">X_actual</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idxs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="c1"># Store in dictionary</span>
    <span class="n">nearest_neighbours</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">nearest_neighbours</span><span class="p">[</span><span class="s1">&#39;distances&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dists</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
    <span class="n">nearest_neighbours</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">real_ids</span>
    
    <span class="k">return</span> <span class="n">nearest_neighbours</span>
</pre></div>
</div>
</div>
</div>
<p>Function to remove identical or nearest neighbour points.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">remove_near_neighbours</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">frac_remove</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove identical or nearest neighbour points&quot;&quot;&quot;</span>
    
    <span class="c1"># Remove points within defined distance    </span>
    <span class="k">if</span> <span class="n">epsilon</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">identical</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;nn_distance&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">epsilon</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">identical</span> <span class="o">==</span> <span class="kc">False</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    
    <span class="c1"># Remove a proportion (closest neighbours)</span>
    <span class="k">if</span> <span class="n">frac_remove</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;nn_distance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">number_to_keep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">frac_remove</span><span class="p">))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">number_to_keep</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span> 
    
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="set-lists-of-categorical-one-hot-coded-and-integer-fields">
<h2>Set lists of categorical (one-hot coded) and integer fields<a class="headerlink" href="#set-lists-of-categorical-one-hot-coded-and-integer-fields" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># One hot column lists</span>

<span class="n">col_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;MoreEqual80y&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;S1Gender&#39;</span><span class="p">,</span>
    <span class="s1">&#39;S1Ethnicity&#39;</span><span class="p">,</span>
    <span class="s1">&#39;S1OnsetInHospital&#39;</span><span class="p">,</span>
    <span class="s1">&#39;S1OnsetTimeType&#39;</span><span class="p">,</span>
    <span class="s1">&#39;S1OnsetDateType&#39;</span><span class="p">,</span>
    <span class="s1">&#39;S1ArriveByAmbulance&#39;</span><span class="p">,</span>
    <span class="s1">&#39;S1AdmissionHour&#39;</span><span class="p">,</span>
    <span class="s1">&#39;S1AdmissionDay&#39;</span><span class="p">,</span>
    <span class="s1">&#39;S1AdmissionQuarter&#39;</span><span class="p">,</span>
    <span class="s1">&#39;S1AdmissionYear&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CongestiveHeartFailure&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Hypertension&#39;</span><span class="p">,</span>
    <span class="s1">&#39;AtrialFibrillation&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Diabetes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;StrokeTIA&#39;</span><span class="p">,</span>
    <span class="s1">&#39;AFAntiplatelet&#39;</span><span class="p">,</span>
    <span class="s1">&#39;AFAnticoagulent_&#39;</span><span class="p">,</span>
    <span class="s1">&#39;AFAnticoagulentVitK&#39;</span><span class="p">,</span>
    <span class="s1">&#39;AFAnticoagulentDOAC&#39;</span><span class="p">,</span>
    <span class="s1">&#39;AFAnticoagulentHeparin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;S2NewAFDiagnosis&#39;</span><span class="p">,</span>
    <span class="s1">&#39;S2StrokeType&#39;</span><span class="p">,</span>
    <span class="s1">&#39;S2TIAInLastMonth&#39;</span><span class="p">]</span>

<span class="n">X_col_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
<span class="n">one_hot_cols</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">col_list</span><span class="p">:</span>
    <span class="n">one_hot</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">X_col_names</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)]</span> <span class="o">==</span> <span class="n">col</span><span class="p">]</span>
    <span class="n">one_hot_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_hot</span><span class="p">)</span>
    
<span class="n">integer_cols</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;S2RankinBeforeStroke&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Loc&#39;</span><span class="p">,</span>
    <span class="s1">&#39;LocQuestions&#39;</span><span class="p">,</span>
    <span class="s1">&#39;LocCommands&#39;</span><span class="p">,</span>
    <span class="s1">&#39;BestGaze&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Visual&#39;</span><span class="p">,</span>
    <span class="s1">&#39;FacialPalsy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;MotorArmLeft&#39;</span><span class="p">,</span>
    <span class="s1">&#39;MotorArmRight&#39;</span><span class="p">,</span>
    <span class="s1">&#39;MotorLegLeft&#39;</span><span class="p">,</span>
    <span class="s1">&#39;MotorLegRight&#39;</span><span class="p">,</span>
    <span class="s1">&#39;LimbAtaxia&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Sensory&#39;</span><span class="p">,</span>
    <span class="s1">&#39;BestLanguage&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Dysarthria&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ExtinctionInattention&#39;</span><span class="p">,</span>
    <span class="s1">&#39;S2NihssArrival&#39;</span><span class="p">]</span>

<span class="c1"># Get min and max for integers (will be used to clip synthetic data)</span>

<span class="n">integer_min_max</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">integer_cols</span><span class="p">:</span>
    <span class="n">col_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">col_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">integer_min_max</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">col_min</span><span class="p">,</span> <span class="n">col_max</span><span class="p">)</span>
    
<span class="c1"># Manually clip age to 30 - 100 to avoid using extremes</span>
<span class="n">integer_min_max</span><span class="p">[</span><span class="s1">&#39;S1AgeOnArrival&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="create-synthetic-data">
<h2>Create synthetic data<a class="headerlink" href="#create-synthetic-data" title="Permalink to this headline">¶</a></h2>
<div class="section" id="create-synthetic-data-and-process-categorical-one-hot-and-integer-data">
<h3>Create synthetic data and process categorical (one-hot) and integer data<a class="headerlink" href="#create-synthetic-data-and-process-categorical-one-hot-and-integer-data" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up list for synthetic data for each stroke team</span>
<span class="n">synthetic_dfs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Loop through stroke teams</span>
<span class="n">groups</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;StrokeTeam&#39;</span><span class="p">)</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span> 

<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">group_df</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>

    <span class="c1"># Report progress</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">Synthesising </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s1"> out of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span><span class="si">}</span><span class="s1"> teams&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># Split data in X and y</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">group_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;StrokeTeam&#39;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">group_df</span><span class="p">[</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">]</span>

    <span class="n">X_col_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># Count number in each class</span>
    <span class="n">count_label_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">count_label_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Will make intial SMOTE data to be 2 x size of data to allow point removal</span>
    <span class="n">n_class_0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">count_label_0</span><span class="p">)</span>
    <span class="n">n_class_1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">count_label_1</span><span class="p">)</span>

    <span class="c1"># Generate raw synthetic data</span>

    <span class="n">X_synthetic</span><span class="p">,</span> <span class="n">y_synthetic</span> <span class="o">=</span> <span class="n">make_synthetic_data_smote</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="p">[</span><span class="n">n_class_0</span><span class="p">,</span> <span class="n">n_class_1</span><span class="p">])</span>

    <span class="c1"># Reconstruct dataframe</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_synthetic</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">X_col_names</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_synthetic</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;StrokeTeam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>

    <span class="c1"># Make one hot as necessary</span>
    <span class="k">for</span> <span class="n">one_hot_list</span> <span class="ow">in</span> <span class="n">one_hot_cols</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">row_index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">one_hot_list</span><span class="p">]</span>
            <span class="n">x_one_hot</span> <span class="o">=</span> <span class="n">make_one_hot</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">row</span><span class="p">[</span><span class="n">x_one_hot</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_one_hot</span><span class="o">.</span><span class="n">values</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span>

    <span class="c1"># Round and clip integer columns</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">integer_cols</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Clip</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">integer_min_max</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">integer_min_max</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Add to list</span>
    <span class="n">synthetic_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># Concatenate results, shuffle and store</span>
<span class="n">synthetic_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">synthetic_dfs</span><span class="p">)</span>
<span class="n">synthetic_data</span> <span class="o">=</span> <span class="n">synthetic_data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Synthesising 132 out of 132 teams
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="add-distance-measure-to-original-data">
<h3>Add distance measure to original data<a class="headerlink" href="#add-distance-measure-to-original-data" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Loop through stroke teams (calculate distance to patients in same unit)</span>
<span class="n">groups</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;StrokeTeam&#39;</span><span class="p">)</span>

<span class="c1"># Set up list for synthetic data for each stroke team</span>
<span class="n">synthetic_dfs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">group_df</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>

    <span class="c1"># Get training, test, and synthetic data for each k-fold</span>
    <span class="n">actual_train</span> <span class="o">=</span> <span class="n">group_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;StrokeTeam&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">synthetic_data</span><span class="p">[</span><span class="s1">&#39;StrokeTeam&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">index</span>
    <span class="n">synthetic_X</span> <span class="o">=</span> <span class="n">synthetic_data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
        <span class="p">[</span><span class="s1">&#39;StrokeTeam&#39;</span><span class="p">,</span> <span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">synthetic_Y</span> <span class="o">=</span> <span class="n">synthetic_data</span><span class="p">[</span><span class="n">mask</span><span class="p">][</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">]</span>

    <span class="c1"># Get nearest neighbour distance and ID</span>
    <span class="n">nearest_neighbours</span> <span class="o">=</span> <span class="n">find_distance_to_closest_real_data</span><span class="p">(</span>
        <span class="n">actual_train</span><span class="p">,</span> <span class="n">synthetic_X</span><span class="p">)</span>

    <span class="c1"># Store data for unit in a dataframe</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">synthetic_data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;nn_distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nearest_neighbours</span><span class="p">[</span><span class="s1">&#39;distances&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;nn_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nearest_neighbours</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">]</span>

    <span class="c1"># Append to list of unit dataframes</span>
    <span class="n">synthetic_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># Concatenate results, shuffle and store</span>
<span class="n">synthetic_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">synthetic_dfs</span><span class="p">)</span>
<span class="n">synthetic_data</span> <span class="o">=</span> <span class="n">synthetic_data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="remove-points-with-identical-points-or-near-neighbours-in-real-data">
<h3>Remove points with identical points or near neighbours in real data<a class="headerlink" href="#remove-points-with-identical-points-or-near-neighbours-in-real-data" title="Permalink to this headline">¶</a></h3>
<p>Remove points with identical points or near neighbours in real data (these are examined by unit - two identical patients may exist if they are associated with different stroke units).~</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Remove points within  </span>
<span class="n">restricted_data</span> <span class="o">=</span> <span class="n">remove_near_neighbours</span><span class="p">(</span><span class="n">synthetic_data</span><span class="p">,</span> <span class="n">min_epsilon</span><span class="p">)</span>

<span class="c1"># Sample from synthetic data to get same size/balance as the original data</span>
<span class="n">num_class_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">num_class_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">mask</span> <span class="o">=</span> <span class="n">restricted_data</span><span class="p">[</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
<span class="n">samples_available</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<span class="n">samples_without_bootstrap</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">num_class_0</span><span class="p">,</span> <span class="n">samples_available</span><span class="p">)</span>
<span class="n">samples_with_bootstrap</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_class_0</span> <span class="o">-</span> <span class="n">samples_without_bootstrap</span><span class="p">)</span>
<span class="n">synth_class_0</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
    <span class="n">restricted_data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">samples_without_bootstrap</span><span class="p">),</span>
    <span class="n">restricted_data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">samples_with_bootstrap</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)])</span>

<span class="n">mask</span> <span class="o">=</span> <span class="n">restricted_data</span><span class="p">[</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
<span class="n">samples_available</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
<span class="n">samples_without_bootstrap</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">num_class_1</span><span class="p">,</span> <span class="n">samples_available</span><span class="p">)</span>
<span class="n">samples_with_bootstrap</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_class_1</span> <span class="o">-</span> <span class="n">samples_without_bootstrap</span><span class="p">)</span>
<span class="n">synth_class_1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
    <span class="n">restricted_data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">samples_without_bootstrap</span><span class="p">),</span>
    <span class="n">restricted_data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">samples_with_bootstrap</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)])</span>

<span class="c1"># Reconstruct into single dataframe and shuffle</span>
<span class="n">synthetic_data_restricted</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">synth_class_0</span><span class="p">,</span> <span class="n">synth_class_1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">synthetic_data_restricted</span> <span class="o">=</span> <span class="n">synthetic_data_restricted</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="save-synthetic-data">
<h3>Save synthetic data<a class="headerlink" href="#save-synthetic-data" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save with same columns and order as orginal data</span>
<span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
<span class="n">synthetic_data_restricted</span> <span class="o">=</span> <span class="n">synthetic_data_restricted</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">data_loc</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;test_run_0.csv&#39;</span>
<span class="n">synthetic_data_restricted</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Note: Rounds of synthetic data may be repeated: ANother set of synthetic data based on this set of synthetic data.</p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./synthetic_data_demo"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="01_synthetic_titanic_data%20_SMOTE.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Creating synthetic Titanic passenger data with SMOTE</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="02b_test_synthetic_descriptive.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Testing of SAMueL-1 synthetic data: descriptive statistics</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By SAMueL project team<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>