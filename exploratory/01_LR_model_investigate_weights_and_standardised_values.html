
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Logistic regression: Understanding hospital one-hot coefficients &#8212; SAMueL Stroke Audit Machine Learning 2</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Logistic regression: manual calculation of model probabilities from feature vales and model coefficients" href="02_manual_calculation_LR_model.html" />
    <link rel="prev" title="Outline" href="outline.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">SAMueL Stroke Audit Machine Learning 2</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../introduction/intro.html">
                    Introduction to SAMueL-2 (Stroke Audit Machine Learning)
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Bid documents
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/plain_english_plan.html">
   Research plan (plain English summary)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/plan.html">
   Research plan (detailed)
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Explaining thrombolysis prediction models with SHAP
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../samuel_shap_paper_1/introduction/intro.html">
   Summary and outline
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_shap_paper_1/xgb_with_feature_selection/outline.html">
     Outline of notebooks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_shap_paper_1/glossary.html">
     Glossary of technical terms
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_shap_paper_1/introduction/odds_prob.html">
     Probability, odds, and SHAP values (log odds shifts)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_shap_paper_1/shap_worked_example.html">
     A simple worked example of Shap
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_shap_paper_1/xgb_with_feature_selection/90_shap_interactions_on_titanic.html">
     Describing model predictions, using SHAP values and SHAP interactions: Using Titanic survival as an example use case.
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_shap_paper_1/xgb_with_feature_selection/01_xgb_combined_fit_feature_selection.html">
     XGBoost feature selection
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_shap_paper_1/xgb_with_feature_selection/91_learning_rate_optimisation.html">
     Evaluation of XGBoost learning rates on distribution of 10k thrombolysis rates
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_shap_paper_1/xgb_with_feature_selection/07_correlation.html">
     Check correlation between features selected for the model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_shap_paper_1/xgb_with_feature_selection/02_xgb_combined_fit_accuracy_key_features.html">
     Measuring accuracy of XGBoost models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_shap_paper_1/xgb_with_feature_selection/03_xgb_combined_shap_key_features.html">
     Explaining XGBoost model predictions with SHAP values
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_shap_paper_1/xgb_with_feature_selection/04_compare_10k_cohort_key_features.html">
     A comparison of 10k cohort thrombolysis rates across hospitals, and comparison with hospital SHAP values
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_shap_paper_1/xgb_with_feature_selection/05_compare_benchmark_decisions_key_features.html">
     Compare local thrombolysis decisions with benchmark decisions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_shap_paper_1/xgb_with_feature_selection/06_predict_differences_between_local_and_benchmark_key_features.html">
     Predicting differences between local and benchmark decisions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_shap_paper_1/xgb_with_feature_selection/08_xgb_combined_fit_shap_high_vs_low_thrombolysing_units.html">
     Comparing Shap values between high and low thrombolysing hospitals
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../samuel_shap_paper_1/xgb_with_feature_selection/09_plot_thrombolysis_at_high_vs_low_thrombolysing_units.html">
     Plotting thrombolysis rate by feature value for low and high thrombolysing hopsitals
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Outcome modelling
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../outcome_modelling/intro.html">
   Summary and outline
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../outcome_modelling/mRS_datasets_full.html">
     Defining modified Rankin Scale (mRS) probability distributions for untreated patients, and predicted distributions if treatment given at time of stroke onset
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../outcome_modelling/mRS_outcomes_maths.html">
     Mathematics for calculating odds and probabilities of mRS-level outcomes after stroke, based on time to reperfusion treatment
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../outcome_modelling/demo_of_outcome_model.html">
     Example output from stroke outcome model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../outcome_modelling/matrix.html">
     Demonstration of added utility depending on time to IVT and MT
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../outcome_modelling/show_outcome_model_code.html">
     Show outcome model python code
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../outcome_modelling/proportion_ischaemic_with_lvo.html">
     Proportion of ischaemic patients with LVO
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Demo of synthetic data method
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../synthetic_data_demo/outline.html">
   Outline
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../synthetic_data_demo/01_synthetic_titanic_data%20_SMOTE.html">
     Creating synthetic Titanic passenger data with SMOTE
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../synthetic_data_demo/02a_synthetic_samuel1_data%20_SMOTE.html">
     Creating synthetic SAMUeL data  data with SMOTE
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../synthetic_data_demo/02b_test_synthetic_descriptive.html">
     Testing of SAMueL-1 synthetic data: descriptive statistics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../synthetic_data_demo/02c_compare_distances_to_real_data.html">
     Testing of SAMueL-1 synthetic data: Compare differences between synthetic data and real data nearest-neighbours
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../synthetic_data_demo/02d_test_synthetic_random_forest.html">
     Testing of SAMueL-1 synthetic data: random forest model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../synthetic_data_demo/02e_test_synthetic_logistic_regression.html">
     Testing of SAMueL-1 synthetic data: logistic regression model
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Appendices
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="outline.html">
   Outline
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Logistic regression: Understanding hospital one-hot coefficients
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="02_manual_calculation_LR_model.html">
     Logistic regression: manual calculation of model probabilities from feature vales and model coefficients
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/exploratory/01_LR_model_investigate_weights_and_standardised_values.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#import-libraries">
   Import libraries
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#function-to-standardise-data">
   Function to standardise data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-data">
   Load data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#initialise-global-objects">
   Initialise global objects
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-logistic-regression-model-combined-model-for-all-hospitals">
   Model: Logistic regression model. Combined model for all hospitals
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#train-model">
     Train model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pass-10k-cohort-through-all-hospital-models-and-get-thrombolysis-rate">
     Pass 10k cohort through all hospital models and get thrombolysis rate
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-thrombolysis-rate-of-10k-cohort-at-each-hospital">
     Plot thrombolysis rate of 10K cohort at each hospital
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#show-stats">
     Show stats
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#how-to-determine-the-hospitals-keeness-to-thrombolyse-from-the-model">
   How to determine the hospitals keeness to thrombolyse from the model.
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-hospitals-10k-patient-thrombolysis-rate-vs-the-hospital-feature-co-efficient">
     Plot the hospitals 10k patient thrombolysis rate vs the hospital feature co-efficient.
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#standardised-values-for-one-hot-features">
     Standardised values for one-hot features
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-pairing-of-standardised-values-with-each-point-coloured-by-the-hospital-admission-values">
     Plot the pairing of standardised values, with each point coloured by the hospital admission values
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-hospitals-10k-patient-thrombolysis-rate-vs-the-hospital-feature-co-efficient-standardised1">
     Plot the hospitals 10k patient thrombolysis rate vs the hospital feature (co-efficient * standardised1)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-hospitals-10k-patient-thrombolysis-rate-vs-the-weighted-hospital-features">
     Plot the hospitals 10k patient thrombolysis rate vs the weighted hospital features
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#result">
   Result
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#extra-analysis">
     Extra analysis
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-graph-hospitals-10k-patient-thrombolysis-rate-vs-the-hospital-feature-co-efficient">
     The graph “hospitals 10k patient thrombolysis rate vs the hospital feature co-efficient”
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-hospitals-10k-patient-thrombolysis-rate-vs-the-hospital-feature-co-efficient-colour-to-represent-admissions">
     Plot the hospitals 10k patient thrombolysis rate vs the hospital feature co-efficient, colour to represent admissions
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#in-summary">
       In summary:
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#any-point-above-the-weight-0-line">
         Any point above the weight = 0 line:
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#any-point-below-the-weight-0-line">
         Any point below the weight = 0 line:
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-different-order-of-the-hosptial-names">
   The different order of the hosptial names
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#observations">
   Observations
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Logistic regression: Understanding hospital one-hot coefficients</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#import-libraries">
   Import libraries
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#function-to-standardise-data">
   Function to standardise data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-data">
   Load data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#initialise-global-objects">
   Initialise global objects
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-logistic-regression-model-combined-model-for-all-hospitals">
   Model: Logistic regression model. Combined model for all hospitals
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#train-model">
     Train model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pass-10k-cohort-through-all-hospital-models-and-get-thrombolysis-rate">
     Pass 10k cohort through all hospital models and get thrombolysis rate
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-thrombolysis-rate-of-10k-cohort-at-each-hospital">
     Plot thrombolysis rate of 10K cohort at each hospital
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#show-stats">
     Show stats
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#how-to-determine-the-hospitals-keeness-to-thrombolyse-from-the-model">
   How to determine the hospitals keeness to thrombolyse from the model.
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-hospitals-10k-patient-thrombolysis-rate-vs-the-hospital-feature-co-efficient">
     Plot the hospitals 10k patient thrombolysis rate vs the hospital feature co-efficient.
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#standardised-values-for-one-hot-features">
     Standardised values for one-hot features
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-pairing-of-standardised-values-with-each-point-coloured-by-the-hospital-admission-values">
     Plot the pairing of standardised values, with each point coloured by the hospital admission values
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-hospitals-10k-patient-thrombolysis-rate-vs-the-hospital-feature-co-efficient-standardised1">
     Plot the hospitals 10k patient thrombolysis rate vs the hospital feature (co-efficient * standardised1)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-hospitals-10k-patient-thrombolysis-rate-vs-the-weighted-hospital-features">
     Plot the hospitals 10k patient thrombolysis rate vs the weighted hospital features
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#result">
   Result
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#extra-analysis">
     Extra analysis
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-graph-hospitals-10k-patient-thrombolysis-rate-vs-the-hospital-feature-co-efficient">
     The graph “hospitals 10k patient thrombolysis rate vs the hospital feature co-efficient”
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-hospitals-10k-patient-thrombolysis-rate-vs-the-hospital-feature-co-efficient-colour-to-represent-admissions">
     Plot the hospitals 10k patient thrombolysis rate vs the hospital feature co-efficient, colour to represent admissions
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#in-summary">
       In summary:
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#any-point-above-the-weight-0-line">
         Any point above the weight = 0 line:
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#any-point-below-the-weight-0-line">
         Any point below the weight = 0 line:
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-different-order-of-the-hosptial-names">
   The different order of the hosptial names
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#observations">
   Observations
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="logistic-regression-understanding-hospital-one-hot-coefficients">
<h1>Logistic regression: Understanding hospital one-hot coefficients<a class="headerlink" href="#logistic-regression-understanding-hospital-one-hot-coefficients" title="Permalink to this headline">#</a></h1>
<blockquote>
<div><p><em>Motivation</em>: We predict thrombolysis use, for any patient, at different hospital by changing the one-hot hospital encoding (while keeping all other patient features unchanged). When we passed a 10K set of patients through all hospitals (by changing the one-hot encoding), we expected that the hospital rank order for the predicted thrombolysis use in that 10K cohort patients would be the same as the rank order of model coefficients for each of the hospital one-hot features. But we did not see exactly the same rank order. This notebook explores (and uncovers) the reason for the different rank orders.</p>
</div></blockquote>
<blockquote>
<div><p><em>Key finding</em>: We discovered that when you standardise the dataset (the process of converting each feature independently to have a mean of 0 and standard deviation of 1), where one-hot features used to have a value of 0 and 1, they each now take a different pair of values. The resulting pair of values depends on how many instances have the value “1” for each hospital (effectively, the hospitals admission rate in the training set). The fewer patients the greater the standardised value for being one-hot. Therefore, with one-hot encoding the contribution of the ‘one hot’ feature depends on both the co-efficient and the standardised value for being one-hot. We cannot therefore take the logistic regression co-efficients in isoltaion and assume that they provide us with the relative importance.</p>
</div></blockquote>
<p>In this notebook we train a combined logistic regression model, and represent the hospital by one-hot encoding. The use of thrombolysis in an independent 10K cohort may then be predicted at each hospital by changing the one-hot encoding to mimic all those 10K patients attending each hospital.
We then show how the coefficient for the hospital one hot features are not in the same rank as the thrombolysis rate, and show how this is related to the product of the coefficient with the standardised value.</p>
<p>Actions from this notebook:</p>
<ol class="simple">
<li><p>check same hospitals in the train and test set if do a one hot</p></li>
<li><p>take set of the hospital names and order alphabetically, then go through the hospitals in that order when send all 10k patients to the same hosptial.</p></li>
</ol>
<p>Learnt:
With one-hot encoding the contribution of the ‘one hot’ feature depends on both the co-efficient and the standardised value for being one-hot (which varies depending on how many are one-hot for each hopsital - the fewer patients the greater the standardised value for being one-hot). We cannot therefore take the logistic regression co-efficients in isoltaion and assume that they provide us with the relative importance.</p>
<p>“Standardization is useful when your data has varying scales and the algorithm you are using does make assumptions about your data having a Gaussian distribution, such as linear regression, logistic regression, and linear discriminant analysis.”
(<a class="reference external" href="https://towardsai.net/p/data-science/how-when-and-why-should-you-normalize-standardize-rescale-your-data-3f083def38ff#:~:text=Standardization%20is%20useful%20when%20your,regression%2C%20and%20linear%20discriminant%20analysis.)">https://towardsai.net/p/data-science/how-when-and-why-should-you-normalize-standardize-rescale-your-data-3f083def38ff#:~:text=Standardization is useful when your,regression, and linear discriminant analysis.)</a></p>
<section id="import-libraries">
<h2>Import libraries<a class="headerlink" href="#import-libraries" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Turn warnings off to keep notebook tidy</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="o">*</span>
<span class="o">%</span><span class="k">matplotlib</span> inline 
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">colors</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>

<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>

<span class="kn">import</span> <span class="nn">math</span> <span class="c1">#used in the sigmoid function</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="function-to-standardise-data">
<h2>Function to standardise data<a class="headerlink" href="#function-to-standardise-data" title="Permalink to this headline">#</a></h2>
<p>This converts all features to have a mean of 0 and a standard deviation of 1.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">standardise_data</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts all data to a similar scale.</span>
<span class="sd">    Standardisation subtracts mean and divides by standard deviation</span>
<span class="sd">    for each feature.</span>
<span class="sd">    Standardised data will have a mena of 0 and standard deviation of 1.</span>
<span class="sd">    The training data mean and standard deviation is used to standardise both</span>
<span class="sd">    training and test set data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Initialise a new scaling object for normalising input data</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span> 

    <span class="c1"># Set up the scaler just on the training set</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>

    <span class="c1"># Apply the scaler to the training and test sets</span>
    <span class="n">train_std</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    <span class="n">test_std</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">train_std</span><span class="p">,</span> <span class="n">test_std</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-data">
<h2>Load data<a class="headerlink" href="#load-data" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_loc</span> <span class="o">=</span> <span class="s1">&#39;../data/sam_1/10k_training_test/&#39;</span>

<span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_loc</span> <span class="o">+</span> <span class="s1">&#39;cohort_10000_train.csv&#39;</span><span class="p">)</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_loc</span> <span class="o">+</span> <span class="s1">&#39;cohort_10000_test.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(78792, 89)
</pre></div>
</div>
</div>
</div>
</section>
<section id="initialise-global-objects">
<h2>Initialise global objects<a class="headerlink" href="#initialise-global-objects" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hospitals</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;StrokeTeam&#39;</span><span class="p">])</span>
<span class="n">hospital_loop_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;StrokeTeam&#39;</span><span class="p">]))</span>

<span class="n">n_hospitals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hospital_loop_order</span><span class="p">)</span>
<span class="n">n_patients</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="model-logistic-regression-model-combined-model-for-all-hospitals">
<h2>Model: Logistic regression model. Combined model for all hospitals<a class="headerlink" href="#model-logistic-regression-model-combined-model-for-all-hospitals" title="Permalink to this headline">#</a></h2>
<p>Logistic regression model trained using one-hot encoded hospitals</p>
<section id="train-model">
<h3>Train model<a class="headerlink" href="#train-model" title="Permalink to this headline">#</a></h3>
<p>Suggestion: Trusting that each Train and Test set has the same hospitals, and so they will create identical ordered hosptial one hots.
Worth putting in a check that each dataset contains the same set of hosptials, like in the cell below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="n">train</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get X and y</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">]</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">]</span>

<span class="c1"># One hot encode hospitals</span>
<span class="nb">list</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">X_train_hosp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="s1">&#39;StrokeTeam&#39;</span><span class="p">],</span> <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;team&#39;</span><span class="p">)</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_train_hosp</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X_train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;StrokeTeam&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X_test_hosp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="s1">&#39;StrokeTeam&#39;</span><span class="p">],</span> <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;team&#39;</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_test</span><span class="p">,</span> <span class="n">X_test_hosp</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X_test</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;StrokeTeam&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Standardise X data</span>
<span class="n">X_train_std</span><span class="p">,</span> <span class="n">X_test_std</span> <span class="o">=</span> <span class="n">standardise_data</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Store number of features</span>
<span class="n">n_features</span> <span class="o">=</span> <span class="n">X_test_std</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Define model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;lbfgs&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Fit model</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_std</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Get predicted probabilities and class</span>
<span class="n">y_probs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_std</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_probs</span> <span class="o">&gt;</span> <span class="mf">0.5</span>

<span class="c1"># Show accuracy</span>
<span class="n">accuracy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_pred</span> <span class="o">==</span> <span class="n">y_test</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Accuracy: 0.8262
</pre></div>
</div>
</div>
</div>
</section>
<section id="pass-10k-cohort-through-all-hospital-models-and-get-thrombolysis-rate">
<h3>Pass 10k cohort through all hospital models and get thrombolysis rate<a class="headerlink" href="#pass-10k-cohort-through-all-hospital-models-and-get-thrombolysis-rate" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hospitals</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="s1">&#39;StrokeTeam&#39;</span><span class="p">])</span>
<span class="n">thrombolysis_rate</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">hospital</span> <span class="ow">in</span> <span class="n">hospitals</span><span class="p">:</span> 
    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\r</span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> 

<span class="c1"># if print out &quot;hosptials&quot;, as this is a set (calculated from </span>
<span class="c1"># set(train[&#39;StrokeTeam&#39;])), the loop is not in alphabetical order, it&#39;s in </span>
<span class="c1"># another order (not seem to be the order fo first appearance in either)</span>

    <span class="c1"># Get test data without thrombolysis hospital or stroke team</span>
    <span class="n">X_test_no_hosp</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;S2Thrombolysis&#39;</span><span class="p">,</span> <span class="s1">&#39;StrokeTeam&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Copy hospital dataframe and change hospital ID (after setting all to zero)</span>
    <span class="n">X_test_adjusted_hospital</span> <span class="o">=</span> <span class="n">X_test_hosp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">X_test_adjusted_hospital</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">team</span> <span class="o">=</span> <span class="s2">&quot;team_&quot;</span> <span class="o">+</span> <span class="n">hospital</span>
    <span class="n">X_test_adjusted_hospital</span><span class="p">[</span><span class="n">team</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="n">X_test_adjusted</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span><span class="n">X_test_no_hosp</span><span class="p">,</span> <span class="n">X_test_adjusted_hospital</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Standardised</span>
    <span class="n">X_train_std</span><span class="p">,</span> <span class="n">X_test_std</span> <span class="o">=</span> <span class="n">standardise_data</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test_adjusted</span><span class="p">)</span>
    
    <span class="c1"># Get predicted probabilities and class</span>
    <span class="n">y_probs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_std</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_probs</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
    <span class="n">thrombolysis_rate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_pred</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

<span class="n">lr_single</span> <span class="o">=</span> <span class="n">thrombolysis_rate</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>132
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-thrombolysis-rate-of-10k-cohort-at-each-hospital">
<h3>Plot thrombolysis rate of 10K cohort at each hospital<a class="headerlink" href="#plot-thrombolysis-rate-of-10k-cohort-at-each-hospital" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">thrombolysis_rate</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Thrombolysis rate&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/01_LR_model_investigate_weights_and_standardised_values_17_0.png" src="../_images/01_LR_model_investigate_weights_and_standardised_values_17_0.png" />
</div>
</div>
</section>
<section id="show-stats">
<h3>Show stats<a class="headerlink" href="#show-stats" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">thrombolysis_rate</span><span class="p">)</span>
<span class="n">stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">thrombolysis_rate</span><span class="p">)</span>

<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean: </span><span class="si">{</span><span class="n">mean</span><span class="si">:</span><span class="s1">0.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;StDev: </span><span class="si">{</span><span class="n">stdev</span><span class="si">:</span><span class="s1">0.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mean: 0.259
StDev: 0.085
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="how-to-determine-the-hospitals-keeness-to-thrombolyse-from-the-model">
<h2>How to determine the hospitals keeness to thrombolyse from the model.<a class="headerlink" href="#how-to-determine-the-hospitals-keeness-to-thrombolyse-from-the-model" title="Permalink to this headline">#</a></h2>
<section id="plot-the-hospitals-10k-patient-thrombolysis-rate-vs-the-hospital-feature-co-efficient">
<h3>Plot the hospitals 10k patient thrombolysis rate vs the hospital feature co-efficient.<a class="headerlink" href="#plot-the-hospitals-10k-patient-thrombolysis-rate-vs-the-hospital-feature-co-efficient" title="Permalink to this headline">#</a></h3>
<p>By design of the combined logistic regression model, each clinical feature has the same coefficient regardless of which hospital the patient attended. Therefore each patient will have the same resulting value from their clinical features, and the only thing that is going to differ in the decision in treatment between hosptials is from the contribution of the hosptial coefficient.</p>
<p>So all patients will have a score, then each hosptial will add (or subtract) a fixed amount from the patients score.</p>
<p>We expected to see that hospitals can be ordered by keeness to thrombolyse based on their hosptial’s one hot feature coefficient.</p>
<p>Note: The rank calculations are in reverse order so that the points on the graph showing the ranked postiions are more relatable to the position of the points on the graph showing the raw values. Hhigh thrombolysis rate = high thrombolysis rate ranking position. High weight value = high weight ranking position.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get feature names</span>
<span class="n">features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="c1"># drop &quot;team_&quot; from the one-hot hospital feature names</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">features</span><span class="p">]</span>

<span class="c1"># get feature weights</span>
<span class="n">feature_weights</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">feature_names</span><span class="p">)</span>
<span class="n">weights</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_weights</span>

<span class="c1"># Put thrombolysis rate in dataframe</span>
<span class="n">thrombo_rate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">hospital_loop_order</span><span class="p">)</span>
<span class="n">thrombo_rate</span><span class="p">[</span><span class="s1">&#39;10K cohort thrombolysis rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thrombolysis_rate</span>

<span class="c1"># join the dataframes on index value, and limit to just those that have values</span>
<span class="c1"># in both dataframes (we will get just the hosptials)</span>
<span class="n">df_weights_thrombrate</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">thrombo_rate</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>

<span class="c1"># plot scatter of thrombolysis rate vs weight</span>
<span class="n">df_weights_thrombrate</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;10K cohort thrombolysis rate&#39;</span><span class="p">,</span> 
                                   <span class="n">y</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">)</span>

<span class="c1"># calculate ranks</span>
<span class="c1"># note that ranks are in reverse order so that the points on the graph are</span>
<span class="c1"># more relatable to the position of the raw values</span>
<span class="c1"># (high thrombolysis rate = high thrombolysis rate ranking position)</span>
<span class="c1"># (high weight value = high weight ranking position)</span>
<span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="s1">&#39;Rank of weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="s1">&#39;Rank of 10K cohort thrombolysis rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="s1">&#39;10K cohort thrombolysis rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span>
                                                        <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="c1"># plot scatter of ranks (thrombolysis rate vs weight)</span>
<span class="n">df_weights_thrombrate</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Rank of 10K cohort thrombolysis rate&#39;</span><span class="p">,</span> 
                                   <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Rank of weight&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;Rank of 10K cohort thrombolysis rate&#39;, ylabel=&#39;Rank of weight&#39;&gt;
</pre></div>
</div>
<img alt="../_images/01_LR_model_investigate_weights_and_standardised_values_21_1.png" src="../_images/01_LR_model_investigate_weights_and_standardised_values_21_1.png" />
<img alt="../_images/01_LR_model_investigate_weights_and_standardised_values_21_2.png" src="../_images/01_LR_model_investigate_weights_and_standardised_values_21_2.png" />
</div>
</div>
<p>The hospital feature coefficient value did not align with the hospitals thrombolysis rate.
And neither did the ranked position of each variable.</p>
<p>Why could this be?</p>
</section>
<section id="standardised-values-for-one-hot-features">
<h3>Standardised values for one-hot features<a class="headerlink" href="#standardised-values-for-one-hot-features" title="Permalink to this headline">#</a></h3>
<p>It is due to the contribution from each hospital is a combination of the hosptial feature coefficient, and the feature value when standardising the data.</p>
<p>Standardising the data scales each input variable separately by subtracting the mean (called centering) and dividing by the standard deviation to shift the distribution to have a mean of zero and a standard deviation of one.</p>
<p>This means that each hospital will have a different standardised value based on the number of admissions for the hospital in the training dataset (the number of times “1” is present, as this will effect the mean and standard deviation of that feature). A hospital with fewer patients will have fewer value “1” and more value “0”, hence the standardised values will be larger so as to obtain the mean 0 stddev 1.</p>
<p>For example if 200/78792 patients go to hospital A, then the standardise values are 0: -0.05 and 1: 19.8.<br />
For example if 50000/78792 patients go to hospital B then the standardise values are 0: -1.3 and 1: 0.7</p>
</section>
<section id="plot-the-pairing-of-standardised-values-with-each-point-coloured-by-the-hospital-admission-values">
<h3>Plot the pairing of standardised values, with each point coloured by the hospital admission values<a class="headerlink" href="#plot-the-pairing-of-standardised-values-with-each-point-coloured-by-the-hospital-admission-values" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># start position in the features list of the one hot hospital features</span>
<span class="n">st_pos</span> <span class="o">=</span> <span class="n">n_features</span> <span class="o">-</span> <span class="n">n_hospitals</span>

<span class="c1"># calculate admission rates (per hospital)</span>
<span class="n">np_unique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="s2">&quot;StrokeTeam&quot;</span><span class="p">],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_hospital_admissions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">np_unique</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">df_hospital_admissions</span><span class="p">[</span><span class="s2">&quot;admissions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np_unique</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">df_hospital_admissions</span><span class="p">[</span><span class="s1">&#39;admissions_rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_hospital_admissions</span><span class="p">[</span><span class="s1">&#39;admissions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="c1"># join admission data to main dataframe</span>
<span class="n">df_weights_thrombrate</span> <span class="o">=</span> <span class="n">df_weights_thrombrate</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_hospital_admissions</span><span class="p">,</span> 
                                                   <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>

<span class="c1"># calculate standardised values (per hospital)</span>
<span class="n">standardised0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(())</span>
<span class="n">standardised1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(())</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_hospitals</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X_train_std</span><span class="p">[:,</span><span class="n">st_pos</span><span class="o">+</span><span class="n">n</span><span class="p">])</span>
    <span class="n">standardised0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">standardised0</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">standardised1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">standardised1</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># join standardised data to main dataframe</span>
<span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="s2">&quot;standardised0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">standardised0</span>
<span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="s2">&quot;standardised1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">standardised1</span>

<span class="c1">#plot scatter of the parings of standardised values</span>
<span class="n">df_weights_thrombrate</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;standardised0&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;standardised1&#39;</span><span class="p">,</span> 
                                   <span class="n">c</span><span class="o">=</span><span class="s1">&#39;admissions&#39;</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
                                   <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># When use colormap in pandas plot, you can loose the x label. </span>
<span class="c1"># &quot;sharex=False&quot; is a workaround </span>
<span class="c1"># (see http://stackoverflow.com/a/31633381/2230844 &amp; </span>
<span class="c1"># https://github.com/pandas-dev/pandas/issues/10611)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;standardised0&#39;, ylabel=&#39;standardised1&#39;&gt;
</pre></div>
</div>
<img alt="../_images/01_LR_model_investigate_weights_and_standardised_values_25_1.png" src="../_images/01_LR_model_investigate_weights_and_standardised_values_25_1.png" />
</div>
</div>
<p>This graph shows that as you increase the admission rate in the training set (blue = low, yellow = high), the resulting standardised values for a one hot feature (to represent the original 0 &amp; 1 values) are smaller.</p>
</section>
<section id="plot-the-hospitals-10k-patient-thrombolysis-rate-vs-the-hospital-feature-co-efficient-standardised1">
<h3>Plot the hospitals 10k patient thrombolysis rate vs the hospital feature (co-efficient * standardised1)<a class="headerlink" href="#plot-the-hospitals-10k-patient-thrombolysis-rate-vs-the-hospital-feature-co-efficient-standardised1" title="Permalink to this headline">#</a></h3>
<p>Now let’s incorporate the standardised values (plot the ranking of these variables in a separate graph also).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="s2">&quot;standardised1 * weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="s2">&quot;standardised1&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">])</span>

<span class="n">df_weights_thrombrate</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="s1">&#39;10K cohort thrombolysis rate&#39;</span><span class="p">,</span> 
                        <span class="n">y</span><span class="o">=</span><span class="s1">&#39;standardised1 * weight&#39;</span><span class="p">)</span>

<span class="c1"># calculate ranks</span>
<span class="c1"># note that ranks are in reverse order so that the points on the graph are</span>
<span class="c1"># more relatable to the position of the raw values</span>
<span class="c1"># high raw value = high ranking position</span>
<span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="s1">&#39;Rank of standardised1 * weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="s1">&#39;standardised1 * weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span>
                                                    <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="c1"># plot scatter of ranks (thrombolysis rate vs weight)</span>
<span class="n">df_weights_thrombrate</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Rank of 10K cohort thrombolysis rate&#39;</span><span class="p">,</span> 
                                   <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Rank of standardised1 * weight&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;Rank of 10K cohort thrombolysis rate&#39;, ylabel=&#39;Rank of standardised1 * weight&#39;&gt;
</pre></div>
</div>
<img alt="../_images/01_LR_model_investigate_weights_and_standardised_values_28_1.png" src="../_images/01_LR_model_investigate_weights_and_standardised_values_28_1.png" />
<img alt="../_images/01_LR_model_investigate_weights_and_standardised_values_28_2.png" src="../_images/01_LR_model_investigate_weights_and_standardised_values_28_2.png" />
</div>
</div>
<p>This shows that the hospitals keeness to thrombolyse can be summarised by the combination of the hosptial one hot feature weight and the standardised value. However there is still a little kink in the graph, we have not yet achieved a perfect 1:1 relationship.</p>
<p>Next also include the sum of the (standardised0 * weight) for the contributions coming from not going to all of the other hosptials?</p>
</section>
<section id="plot-the-hospitals-10k-patient-thrombolysis-rate-vs-the-weighted-hospital-features">
<h3>Plot the hospitals 10k patient thrombolysis rate vs the weighted hospital features<a class="headerlink" href="#plot-the-hospitals-10k-patient-thrombolysis-rate-vs-the-weighted-hospital-features" title="Permalink to this headline">#</a></h3>
<p>For each hospital plot the weighted hospital one-hot features (the summed dot product of standardised one-hot encoding and one-hot co-efficients).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(())</span>

<span class="c1">#plot scatter of thrombolysis rate vs weight, colour points by admissions</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df_weights_thrombrate</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="s2">&quot;standardised0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">factor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_weights_thrombrate</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;standardised1&quot;</span><span class="p">]</span>
    <span class="n">sumproduct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">],</span> <span class="n">factor</span><span class="p">)</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">sumproduct</span><span class="p">)</span>

<span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;std1 * weight + sum hosps(std0 * weight)&quot;</span>
<span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="n">y_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span>

<span class="n">df_weights_thrombrate</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;10K cohort thrombolysis rate&#39;</span><span class="p">,</span> 
                                   <span class="n">y</span><span class="o">=</span><span class="n">y_label</span><span class="p">)</span>

<span class="c1"># calculate ranks</span>
<span class="c1"># note that ranks are in reverse order so that the points on the graph are</span>
<span class="c1"># more relatable to the position of the raw values</span>
<span class="c1"># high raw value = high ranking position</span>
<span class="n">y_label_rank</span> <span class="o">=</span> <span class="s2">&quot;Rank of [std1 * w + sum hosps(std0 * w)]&quot;</span>
<span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="n">y_label_rank</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="n">y_label</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="c1">#plot scatter of ranks (thrombolysis rate vs weight)</span>
<span class="n">df_weights_thrombrate</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Rank of 10K cohort thrombolysis rate&#39;</span><span class="p">,</span>
                                   <span class="n">y</span><span class="o">=</span><span class="n">y_label_rank</span> <span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/01_LR_model_investigate_weights_and_standardised_values_30_0.png" src="../_images/01_LR_model_investigate_weights_and_standardised_values_30_0.png" />
<img alt="../_images/01_LR_model_investigate_weights_and_standardised_values_30_1.png" src="../_images/01_LR_model_investigate_weights_and_standardised_values_30_1.png" />
</div>
</div>
</section>
</section>
<section id="result">
<h2>Result<a class="headerlink" href="#result" title="Permalink to this headline">#</a></h2>
<p>The hospitals keeness to thrombolyse can be summarised by the combination of the feature weight and the standardised value.</p>
<section id="extra-analysis">
<h3>Extra analysis<a class="headerlink" href="#extra-analysis" title="Permalink to this headline">#</a></h3>
</section>
<section id="the-graph-hospitals-10k-patient-thrombolysis-rate-vs-the-hospital-feature-co-efficient">
<h3>The graph “hospitals 10k patient thrombolysis rate vs the hospital feature co-efficient”<a class="headerlink" href="#the-graph-hospitals-10k-patient-thrombolysis-rate-vs-the-hospital-feature-co-efficient" title="Permalink to this headline">#</a></h3>
<p>Let’s revisit the earlier graphs showing the hospitals 10k patient thrombolysis rate vs the hospital feature co-efficient, now also show the admission rate from the training set.</p>
</section>
<section id="plot-the-hospitals-10k-patient-thrombolysis-rate-vs-the-hospital-feature-co-efficient-colour-to-represent-admissions">
<h3>Plot the hospitals 10k patient thrombolysis rate vs the hospital feature co-efficient, colour to represent admissions<a class="headerlink" href="#plot-the-hospitals-10k-patient-thrombolysis-rate-vs-the-hospital-feature-co-efficient-colour-to-represent-admissions" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#plot scatter of thrombolysis rate vs weight, colour points by admissions</span>
<span class="n">df_weights_thrombrate</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;10K cohort thrombolysis rate&#39;</span><span class="p">,</span> 
                                   <span class="n">y</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> 
                                   <span class="n">c</span><span class="o">=</span><span class="s1">&#39;admissions&#39;</span><span class="p">,</span> 
                                   <span class="n">colormap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;10K cohort thrombolysis rate&#39;, ylabel=&#39;weight&#39;&gt;
</pre></div>
</div>
<img alt="../_images/01_LR_model_investigate_weights_and_standardised_values_34_1.png" src="../_images/01_LR_model_investigate_weights_and_standardised_values_34_1.png" />
</div>
</div>
<p>Expected to see all blue on the underside of the 1:1 line, and yellow on the upper side of the 1:1 line.</p>
<p>Taking the two points on the right (with 10k thrombolysis rate of ~0.45 and a weight of ~0.5) as an example, these have a higher thrombolysis rate than we would expect by just assessing the weights. The 1:1 line suggests a weight of 0.5 gives a thrombolysis rate of ~0.35.</p>
<p>For these hospitals to have a higher thrombolysis rate than weights imply, means they have a relatively larger standardised value to represent “1” (which bumps the thrombolysis rate up). This is obtained by hospitals having fewer admissions.</p>
<p>The dark blue shows that these hosptials do have a low admission.</p>
<p>Let’s identify these two hosptials that are these two outliers.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask1</span> <span class="o">=</span> <span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="s1">&#39;10K cohort thrombolysis rate&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.42</span>
<span class="n">mask2</span> <span class="o">=</span> <span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.04</span>
<span class="n">mask3</span> <span class="o">=</span> <span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">mask1</span> <span class="o">*</span> <span class="n">mask2</span> <span class="o">*</span> <span class="n">mask3</span>
<span class="n">outlier_hosp</span> <span class="o">=</span> <span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
<span class="n">df_hospital_admissions</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">outlier_hosp</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>admissions</th>
      <th>admissions_rank</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>CNBGF2713O</th>
      <td>135</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>HPWIF9956L</th>
      <td>178</td>
      <td>8.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_weights_thrombrate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">outlier_hosp</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>weight</th>
      <th>10K cohort thrombolysis rate</th>
      <th>Rank of weight</th>
      <th>Rank of 10K cohort thrombolysis rate</th>
      <th>admissions</th>
      <th>admissions_rank</th>
      <th>standardised0</th>
      <th>standardised1</th>
      <th>standardised1 * weight</th>
      <th>Rank of standardised1 * weight</th>
      <th>std1 * weight + sum hosps(std0 * weight)</th>
      <th>Rank of [std1 * w + sum hosps(std0 * w)]</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>CNBGF2713O</th>
      <td>0.044276</td>
      <td>0.4410</td>
      <td>112.0</td>
      <td>131.0</td>
      <td>135</td>
      <td>4.0</td>
      <td>-0.041428</td>
      <td>24.138029</td>
      <td>1.068733</td>
      <td>132.0</td>
      <td>1.069945</td>
      <td>131.0</td>
    </tr>
    <tr>
      <th>HPWIF9956L</th>
      <td>0.047894</td>
      <td>0.4324</td>
      <td>114.0</td>
      <td>130.0</td>
      <td>178</td>
      <td>8.0</td>
      <td>-0.047584</td>
      <td>21.015511</td>
      <td>1.006517</td>
      <td>130.0</td>
      <td>1.008173</td>
      <td>130.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>But this argument does not hold for the hosptial with the high admission (yellow) which is also to the RHS of the 1:1 line. Would expect a hospital with a high admission to have a lower std1 value, and so the thrombolysis rate to be lower than the weight alone would imply. But the thrombolysis rate is higher.</p>
<p>Let’s extract that hospital’s details.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask1</span> <span class="o">=</span> <span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="s1">&#39;10K cohort thrombolysis rate&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.2</span>
<span class="n">mask2</span> <span class="o">=</span> <span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="s1">&#39;10K cohort thrombolysis rate&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.22</span>
<span class="n">mask3</span> <span class="o">=</span> <span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.05</span>
<span class="n">mask4</span> <span class="o">=</span> <span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">0.06</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">mask1</span> <span class="o">*</span> <span class="n">mask2</span> <span class="o">*</span> <span class="n">mask3</span> <span class="o">*</span> <span class="n">mask4</span>
<span class="n">outlier_hosp</span> <span class="o">=</span> <span class="n">df_weights_thrombrate</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
<span class="n">df_hospital_admissions</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">outlier_hosp</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>admissions</th>
      <th>admissions_rank</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>FAJKD7118X</th>
      <td>1756</td>
      <td>132.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_weights_thrombrate</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">outlier_hosp</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>weight</th>
      <th>10K cohort thrombolysis rate</th>
      <th>Rank of weight</th>
      <th>Rank of 10K cohort thrombolysis rate</th>
      <th>admissions</th>
      <th>admissions_rank</th>
      <th>standardised0</th>
      <th>standardised1</th>
      <th>standardised1 * weight</th>
      <th>Rank of standardised1 * weight</th>
      <th>std1 * weight + sum hosps(std0 * weight)</th>
      <th>Rank of [std1 * w + sum hosps(std0 * w)]</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>FAJKD7118X</th>
      <td>-0.053039</td>
      <td>0.2096</td>
      <td>18.0</td>
      <td>39.0</td>
      <td>1756</td>
      <td>132.0</td>
      <td>-0.150979</td>
      <td>6.623455</td>
      <td>-0.351302</td>
      <td>39.0</td>
      <td>-0.359932</td>
      <td>39.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The reason is because the weight is negative, and so now the effect is opposite.</p>
<p>For this hospital to have a higher thrombolysis rate than the weight implies, means it has a relatively smaller standardised value to represent “1” (which minimises the amount at which the thrombolysis is reduced, when the weight is negative). This is obtained by hospitals having larger admissions.</p>
<section id="in-summary">
<h4>In summary:<a class="headerlink" href="#in-summary" title="Permalink to this headline">#</a></h4>
<section id="any-point-above-the-weight-0-line">
<h5>Any point above the weight = 0 line:<a class="headerlink" href="#any-point-above-the-weight-0-line" title="Permalink to this headline">#</a></h5>
<p>Expect blue admissions to the RHS of the 1:1 line, and yellow admissions to the LHS of the 1:1 line.<br />
(why expect blue points on RHS of the 1:1 line: the weights are positive and so want a smaller admission hospital to have a larger standardised value to push the weight to a larger than expected thrombolysis rate).\</p>
</section>
<section id="any-point-below-the-weight-0-line">
<h5>Any point below the weight = 0 line:<a class="headerlink" href="#any-point-below-the-weight-0-line" title="Permalink to this headline">#</a></h5>
<p>Expect yellow admissions to the RHS of the 1:1 line, and blue admissions to the LHS of the 1:1 line.<br />
(why expect yellow points on RHS of the 1:1 line: the weights are negative and so want a larger admission hospital to have a smaller standardised value to reduce the amount that the weight impedes the thrombolysis rate, and so end up with a larger than expected thrombolysis rate).</p>
</section>
</section>
</section>
</section>
<section id="the-different-order-of-the-hosptial-names">
<h2>The different order of the hosptial names<a class="headerlink" href="#the-different-order-of-the-hosptial-names" title="Permalink to this headline">#</a></h2>
<p>To get the set of unique hospital names depends on which object you call</p>
<p>train[‘StrokeTeam’]: order of all the instances
np.unique(train[‘StrokeTeam’]): alphabetical
set(train[‘StrokeTeam’]): unordered, but shown alphabetical
list(set(train[‘StrokeTeam’])): random order, can change</p>
<p>When loop through all of the hospitals (to send each all the 10k patients in the test set to the same hosptial) it uses the order returned by list(set(train[‘StrokeTeam’])). By using the team name, the code finds the corresponding column in the dataframe column titles, and sets that column to all be 1 (the rest as zero).</p>
<p>One hot columns are returned in alphabetical order (and so do not reflect the hosptial order in the “StrokeTeam” column, or the list(set()) order).</p>
<p>When one hot the StrokeTeam column, the individual team columns are in alphabetical order. These are added to the model in that order.
Feature weights for the hospitals are in hospital alphabetical order.
Standardised data for the hospitals are in hospital alphabetical order.</p>
</section>
<section id="observations">
<h2>Observations<a class="headerlink" href="#observations" title="Permalink to this headline">#</a></h2>
<p>We discovered that when you standardise the dataset (the process of converting each feature independently to have a mean of 0 and standard deviation of 1), where one-hot features used to have a value of 0 and 1, they each now take a different pair of values. The resulting pair of values depends on how many instances have the value “1” for each hospital (effectively, the hospitals admission rate in the training set). The fewer patients the greater the standardised value for being one-hot. Therefore, with one-hot encoding the contribution of the ‘one hot’ feature depends on both the co-efficient and the standardised value for being one-hot. We cannot therefore take the logistic regression co-efficients in isoltaion and assume that they provide us with the relative importance.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./exploratory"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="outline.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Outline</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="02_manual_calculation_LR_model.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Logistic regression: manual calculation of model probabilities from feature vales and model coefficients</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By SAMueL project team<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>